---
phase: 14-scheduler-clone-bug-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scheduler/scheduler.rs
  - tests/scheduler_tests.rs
autonomous: true

must_haves:
  truths:
    - "Scheduler clone bug fix is verified working (all tests pass)"
    - "Test name matches requirements (test_update_iteration_batch_cannot_clobber_new_tokens exists)"
    - "Documentation reflects current implementation state"
  artifacts:
    - path: "src/scheduler/scheduler.rs"
      provides: "Scheduler with token preservation in update_iteration_batch"
      min_lines: 650
      contains: "generated_tokens.len()"
    - path: "tests/scheduler_tests.rs or src/scheduler/scheduler.rs"
      provides: "Test for stale batch clone handling"
      exports: ["test_update_iteration_batch_cannot_clobber_new_tokens"]
  key_links:
    - from: "src/engine.rs:728"
      to: "src/scheduler/scheduler.rs:602"
      via: "update_iteration_batch call"
      pattern: "update_iteration_batch"
---

<objective>
Verify and document the scheduler clone bug fix.

The bug was FIXED in a previous change (lines 636-640 in scheduler.rs) with a workaround that compares token counts. All 34 scheduler tests currently PASS. This phase verifies the fix is robust and addresses documentation inconsistencies.

**Primary issues:**
1. Requirements mention test `test_update_iteration_batch_cannot_clobber_new_tokens` but actual test is `test_stale_batch_clone_does_not_overwrite_scheduler`
2. FIX-3 documentation marks the fix as "UNCOMMITTED" but code is in place
3. Optional: Entry API refactor for cleaner implementation

Purpose: Close HYGIENE-01 requirement by verifying the scheduler clone bug is fixed and tests match requirements.

Output: Verified working fix, aligned test naming, updated documentation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-scheduler-clone-bug-fix/14-RESEARCH.md

# Key source files
@src/scheduler/scheduler.rs
@src/engine.rs
@docs/FIX_3_SCHEDULER_TOKEN_PRESERVATION_IMPLEMENTATION.md
</context>

<tasks>

<task type="auto">
  <name>Verify current fix state and run all scheduler tests</name>
  <files>src/scheduler/scheduler.rs</files>
  <action>
    1. Read scheduler.rs lines 602-648 to confirm workaround is in place
    2. Run full scheduler test suite: `cargo test --lib -- scheduler::`
    3. Verify test_stale_batch_clone_does_not_overwrite_scheduler passes
    4. Document current state - the workaround IS implemented and working

    Do NOT modify code yet - this is verification first (TDD principle: prove current state).
  </action>
  <verify>
    `cargo test --lib -- scheduler:: 2>&1 | grep "test result:"` shows "34 passed; 0 failed"
  </verify>
  <done>
    All 34 scheduler tests pass. Workaround at lines 636-640 confirmed in place.
  </done>
</task>

<task type="auto">
  <name>Add test matching requirements name (alias)</name>
  <files>src/scheduler/scheduler.rs</files>
  <action>
    Requirements specify test `test_update_iteration_batch_cannot_clobber_new_tokens` but existing test is `test_stale_batch_clone_does_not_overwrite_scheduler`.

    Add a test with the required name as an ALIAS to the existing test. This ensures requirements are met without removing the existing descriptive test name.

    Location: In scheduler.rs tests module (around line 1030, after test_stale_batch_clone_does_not_overwrite_scheduler)

    Implementation:
    ```rust
    #[test]
    fn test_update_iteration_batch_cannot_clobber_new_tokens() {
        // This test is an alias for test_stale_batch_clone_does_not_overwrite_scheduler
        // to match the HYGIENE-01 requirement naming
        test_stale_batch_clone_does_not_overwrite_scheduler();
    }
    ```

    This approach:
    - Preserves the existing descriptive test name
    - Adds the required test name from requirements
    - Reuses the same test logic (DRY)
  </action>
  <verify>
    `cargo test --lib -- test_update_iteration_batch_cannot_clobber_new_tokens 2>&1 | grep "test result:"` shows "1 passed"
  </verify>
  <done>
    Test with required name exists and passes. Requirements HYGIENE-01 test coverage satisfied.
  </done>
</task>

<task type="auto">
  <name>Update FIX-3 documentation status</name>
  <files>docs/FIX_3_SCHEDULER_TOKEN_PRESERVATION_IMPLEMENTATION.md</files>
  <action>
    Update docs/FIX_3_SCHEDULER_TOKEN_PRESERVATION_IMPLEMENTATION.md:

    Line 5: Change `Status: IMPLEMENTED (UNCOMMITTED)` to `Status: IMPLEMENTED (VERIFIED Phase 14)`

    Add a section at end:
    ```markdown
    ## Phase 14 Verification (2026-01-19)

    - All 34 scheduler tests passing
    - Test alias added: `test_update_iteration_batch_cannot_clobber_new_tokens`
    - Workaround confirmed in place at lines 636-640
    - Engine correctly calls snapshot_request() for fresh state
    - HYGIENE-01 requirement satisfied
    ```
  </action>
  <verify>
    `grep "VERIFIED Phase 14" docs/FIX_3_SCHEDULER_TOKEN_PRESERVATION_IMPLEMENTATION.md` returns the added line
  </verify>
  <done>
    FIX-3 documentation reflects current verified state. Status no longer says "UNCOMMITTED".
  </done>
</task>

</tasks>

<verification>
Run full scheduler test suite to confirm no regressions:
```bash
cargo test --lib -- scheduler::
```

Expected: 35 tests passing (34 original + 1 alias)

Verify requirements traceability:
```bash
grep -r "test_update_iteration_batch_cannot_clobber_new_tokens" src/
```
Expected: Test found in scheduler.rs
</verification>

<success_criteria>
1. All 35 scheduler tests pass (34 + 1 alias)
2. Test `test_update_iteration_batch_cannot_clobber_new_tokens` exists
3. FIX-3 documentation updated with Phase 14 verification
4. Requirements HYGIENE-01 marked as satisfied in REQUIREMENTS.md traceability
</success_criteria>

<output>
After completion, create `.planning/phases/14-scheduler-clone-bug-fix/14-01-SUMMARY.md`
</output>
