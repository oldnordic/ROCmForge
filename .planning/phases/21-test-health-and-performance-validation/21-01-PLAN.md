---
phase: 21-test-health-and-performance-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ggml/hip_backend/ops/mod.rs
  - src/loader/gguf.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All tests compile without cfg(feature) import errors"
    - "Lib tests can run without segfaults"
    - "Integration tests can run with rocm feature"
  artifacts:
    - path: "src/ggml/hip_backend/ops/mod.rs"
      provides: "Module exports with correct cfg(feature) gates"
      exports: ["dequantize_q4_0_kernel_cached"]
    - path: "src/loader/gguf.rs"
      provides: "GGUF loader with correct cfg(feature) imports"
  key_links:
    - from: "src/ggml/hip_backend/ops/mod.rs"
      to: "src/ggml/hip_backend/ops/q4_0_dequant.rs"
      via: "pub use with #[cfg(feature = \"rocm\")]"
      pattern: "#\\[cfg\\(feature = \"rocm\"\\)\\]"
---

<objective>
Fix compilation errors caused by missing cfg(feature = "rocm") gates on re-exports.

Purpose: Tests fail to compile because `dequantize_q4_0_kernel_cached` is behind `#[cfg(feature = "rocm")]` in q4_0_dequant.rs but the re-export in mod.rs is not gated. This causes compilation errors when running without --features rocm.

Output: All tests compile successfully with and without --features rocm flag
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

@src/ggml/hip_backend/ops/mod.rs
@src/ggml/hip_backend/ops/q4_0_dequant.rs
@src/loader/gguf.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix cfg(feature) gates on re-exports in mod.rs</name>
  <files>src/ggml/hip_backend/ops/mod.rs</files>
  <action>
    The issue: `dequantize_q4_0_kernel_cached` is defined with `#[cfg(feature = "rocm")]` in q4_0_dequant.rs but the pub use in mod.rs is not gated.

    Fix: Apply `#[cfg(feature = "rocm")]` to the re-export lines in mod.rs for GPU-only functions:
    - Line 30: `dequantize_q4_0_kernel_cached` - add #[cfg(feature = "rocm")]
    - Line 31: `get_or_init_q4_0_dequant_cache` - add #[cfg(feature = "rocm")]
    - Line 32: `dequantize_q4_0_cpu_upload` - add #[cfg(feature = "rocm")] if GPU-only

    Check lines 28-34 in mod.rs and apply cfg gates only to the GPU-specific exports.
    CPU fallback functions (dequantize_q4_0_with_fallback, dequantize_q4_0_cpu) should remain un-gated.

    Similar fixes may be needed for q4_k_dequant and q6_k_dequant exports.
  </action>
  <verify>
    cargo test --lib --no-run 2>&1 | grep -E "error|warning.*dequantize.*kernel_cached" || echo "No cfg-related errors"
  </verify>
  <done>
    Tests compile without cfg(feature) import errors. Both `cargo test --lib` and `cargo test --features rocm --lib` compile successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix cfg(feature) import in gguf.rs</name>
  <files>src/loader/gguf.rs</files>
  <action>
    The issue: Line 10 imports `dequantize_q4_0_kernel_cached` directly but the function is cfg-gated.

    Fix: Either:
    1. Wrap the import in #[cfg(feature = "rocm")] if only used in GPU paths, OR
    2. Change the import to use the module-level re-export which handles cfg gating

    Check where this function is used in gguf.rs. If it's only used within #[cfg(feature = "rocm")] blocks, gate the import. Otherwise, use conditional compilation or runtime fallback.

    Reference: The pattern from Phase 17-01/17-02 where GPU kernels were added with CPU fallbacks.
  </action>
  <verify>
    cargo test --lib --no-run 2>&1 | grep -E "unresolved import.*dequantize_q4_0_kernel_cached" || echo "Import error resolved"
  </verify>
  <done>
    The import compiles successfully. Module builds without unresolved import errors.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `cargo check` passes without cfg-related errors
2. `cargo check --features rocm` passes
3. `cargo test --lib --no-run` compiles successfully
4. No "unresolved import" errors for dequantize_q4_0_kernel_cached
</verification>

<success_criteria>
- TEST-01 prerequisite: Tests compile successfully
- Zero compilation errors related to cfg(feature = "rocm")
- Both default and rocm feature builds work
</success_criteria>

<output>
After completion, create `.planning/phases/21-test-health-and-performance-validation/21-01-SUMMARY.md`
</output>
