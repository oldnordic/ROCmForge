---
phase: 21-test-health-and-performance-validation
plan: 04
type: execute
wave: 3
depends_on: ["21-01", "21-02", "21-03"]
files_modified:
  - tests/e2e_inference_tests.rs
  - tests/common/mod.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "E2E tests check for ROCFORGE_TEST_MODEL env var"
    - "Tests skip gracefully when model file not found"
    - "No #[ignore] attribute blocks test execution when model is available"
  artifacts:
    - path: "tests/e2e_inference_tests.rs"
      provides: "End-to-end inference tests with graceful skip"
      min_lines: 400
    - path: "tests/common/mod.rs"
      provides: "has_test_model() and test_model_path() helper functions"
      exports: ["has_test_model", "test_model_path"]
  key_links:
    - from: "tests/e2e_inference_tests.rs"
      to: "tests/common/mod.rs"
      via: "use common::{has_test_model, test_model_path}"
      pattern: "has_test_model\\(\\)|test_model_path\\(\\)"
---

<objective>
Enable E2E tests with graceful skip when model not found.

Purpose: E2E tests are currently #[ignore]d. They should run when ROCFORGE_TEST_MODEL env var is set and skip gracefully when the model file doesn't exist. The common/mod.rs already has `has_test_model()` and `test_model_path()` helpers.

Output: E2E tests run with `--ignored` flag when ROCFORGE_TEST_MODEL is set, skip gracefully otherwise.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

@tests/e2e_inference_tests.rs
@tests/common/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify E2E test graceful skip implementation</name>
  <files>tests/e2e_inference_tests.rs</files>
  <action>
    Check the E2E tests. They currently have:
    - #[ignore] attributes on tests that require a model
    - `has_test_model()` check inside tests that returns Ok(()) early

    The pattern is correct (tests are #[ignore] by default and check has_test_model() internally).

    Verify:
    1. All model-requiring tests have #[ignore] attribute
    2. All such tests call `has_test_model()` and return Ok(()) early if false
    3. Error handling tests (like test_invalid_model_path) do NOT have #[ignore] since they don't need a model
    4. Common module is properly imported: `mod common; use common::{has_test_model, test_model_path};`

    If any issues found, fix them. The implementation should already be correct based on the file read - this task is verification.

    Also verify the file compiles with `cargo test --test e2e_inference_tests --no-run`.
  </action>
  <verify>
    # Verify tests can be listed (requires compilation)
    cargo test --test e2e_inference_tests --list 2>&1 | head -20
    # Verify skip behavior works
    ROCFORGE_TEST_MODEL=/nonexistent cargo test --test e2e_inference_tests -- --ignored 2>&1 | grep -E "Skipping|test result" | head -10
  </verify>
  <done>
    E2E tests have correct #[ignore] attributes. Tests skip gracefully with message when model not found. Tests are ready to run with ROCFORGE_TEST_MODEL set.
  </done>
</task>

</tasks>

<verification>
After task completes:
1. E2E tests compile without errors
2. Running without ROCFORGE_TEST_MODEL shows "Skipping" messages for model-requiring tests
3. Running with ROCFORGE_TEST_MODEL pointing to valid model would execute tests (verification only - actual model not required for this task)
</verification>

<success_criteria>
- TEST-03: E2E tests are unignored and run with ROCFORGE_TEST_MODEL env var
- TEST-04: E2E tests have graceful skip when model file not found
- All E2E tests compile successfully
</success_criteria>

<output>
After completion, create `.planning/phases/21-test-health-and-performance-validation/21-04-SUMMARY.md`
</output>
