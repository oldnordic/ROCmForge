---
phase: 16-gpu-rope-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - build.rs
  - src/attention/rope.rs
  - src/attention/kernels.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "RoPE kernel is compiled and loaded via build.rs (ROPE-04)"
    - "CPU-GPU transfer overhead is eliminated - no to_host_vec in GPU path (ROPE-06)"
    - "GPU RoPE execution flow is documented and traceable (ROPE-01)"
  artifacts:
    - path: "build.rs"
      provides: "Kernel compilation configuration"
      contains: "rope\\.hip|position_embeddings\\.hip"
    - path: "src/attention/rope.rs"
      provides: "apply_rope_device() GPU method"
      contains: "apply_rope_device"
    - path: "src/attention/kernels.rs"
      provides: "rope_gpu_kernel() wrapper"
      contains: "rope_gpu_kernel"
  key_links:
    - from: "build.rs"
      to: "kernels/rope.hip"
      via: "KERNELS list includes rope.hip"
      pattern: "rope\\.hip"
    - from: "src/attention/rope.rs"
      to: "src/attention/kernels.rs"
      via: "apply_rope_device() calls rope_gpu_kernel()"
      pattern: "rope_gpu_kernel"
    - from: "src/model/glm_position.rs"
      to: "src/attention/rope.rs"
      via: "apply_position_embeddings_device() calls apply_rope_device()"
      pattern: "apply_rope_device"
---

<objective>
Verify RoPE kernel compilation and GPU path purity.

Purpose: Confirm RoPE kernels compile correctly and the GPU execution path eliminates CPU round-trip overhead. This is foundational verification before adding new tests.

Output: Verified kernel compilation with HSACO files present, confirmed pure GPU execution path without to_host_vec() in hot path.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/16-gpu-rope-implementation/16-RESEARCH.md
@.planning/ROADMAP.md

@build.rs
@src/attention/rope.rs
@src/attention/kernels.rs
</context>

<tasks>

<task type="auto">
  <name>Verify RoPE kernel compilation and loading (ROPE-04)</name>
  <files>build.rs</files>
  <action>
    Verify that RoPE kernels are compiled and HSACO files are generated:
    1. Read build.rs lines 48-52 to confirm rope.hip and position_embeddings.hip are in KERNELS list
    2. Run cargo clean to ensure fresh build
    3. Run: cargo build --features rocm 2>&1 | tee /tmp/rope_build.log
    4. Verify build output contains "Compiled kernels/rope.hip" and "Compiled kernels/position_embeddings.hip"
    5. Confirm ROPE_HSACO and POSITION_EMBEDDINGS_HSACO env vars are emitted during build
    6. Check target/debug/build/*/out/ for rope_kernel.hsaco and position_embeddings_kernel.hsaco

    DO NOT modify build.rs - kernels are already in the compilation list. Just verify they compile.
  </action>
  <verify>
    # Build logs show kernel compilation
    grep -i "rope" /tmp/rope_build.log | grep -i "compiled"
    # HSACO files exist
    ls -la target/debug/build/*/out/rope_kernel.hsaco target/debug/build/*/out/position_embeddings_kernel.hsaco 2>/dev/null
    # Env vars are set (check cargo build output)
    grep -E "ROPE_HSACO|POSITION_EMBEDDINGS_HSACO" /tmp/rope_build.log
  </verify>
  <done>
    RoPE kernel HSACO files exist in build output directory AND build logs confirm successful compilation of both kernels
  </done>
</task>

<task type="auto">
  <name>Verify no CPU round-trip in GPU RoPE path (ROPE-06)</name>
  <files>src/attention/rope.rs</files>
  <action>
    Verify that apply_q_device() and apply_k_device() do NOT download to CPU:
    1. Read src/attention/rope.rs apply_rope_device() method (lines 226-327)
    2. Confirm NO to_host_vec() calls in the GPU hot path (lines 280-320)
    3. Confirm cos/sin are uploaded via from_host_vec() at line ~272 (required - these are computed on CPU)
    4. Verify the GPU kernel is called at line ~288 and synchronize() is called at line ~290
    5. Document findings in code comment above apply_rope_device()

    If any to_host_vec() is found in the hot path, this is a bug requiring fix. The current implementation should be clean.
  </action>
  <verify>
    # Confirm no to_host_vec in apply_rope_device
    ! grep -A100 "pub fn apply_rope_device" src/attention/rope.rs | grep "to_host_vec"
    # Verify from_host_vec is used for cos/sin upload (expected)
    grep -A100 "pub fn apply_rope_device" src/attention/rope.rs | grep "from_host_vec"
    # Verify kernel call exists
    grep -A100 "pub fn apply_rope_device" src/attention/rope.rs | grep "rope_gpu_kernel"
  </verify>
  <done>
    Verified apply_rope_device() has no CPU round-trip - only cos/sin upload via from_host_vec(), then pure GPU execution with synchronize()
  </done>
</task>

<task type="auto">
  <name>Document RoPE GPU execution flow (ROPE-01)</name>
  <files>src/model/glm_position.rs</files>
  <action>
    Document the complete GPU RoPE execution flow:
    1. Trace from execution_plan_src.rs self_attention() line 1948: apply_position_embeddings_device()
    2. To glm_position.rs line 278-353: GPU kernel attempt with CPU fallback
    3. To kernels.rs line 1092-1148: position_embeddings_gpu_kernel()
    4. To position_embeddings.hip: actual HIP kernel execution
    5. Add comment block above apply_position_embeddings_device() at line 278 explaining:
       - GPU kernel is tried first (position_embeddings_gpu_kernel)
       - Falls back to CPU only if kernel fails
       - For successful GPU execution, no CPU round-trip occurs
  </action>
  <verify>
    grep -n "GPU RoPE execution flow" src/model/glm_position.rs
  </verify>
  <done>
    Execution flow documented in code comments at line 278 in glm_position.rs explaining GPU-first strategy with CPU fallback
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. RoPE HSACO files exist in build output (rope_kernel.hsaco, position_embeddings_kernel.hsaco)
2. Build logs show successful kernel compilation
3. No to_host_vec() in GPU RoPE hot path (only from_host_vec for cos/sin upload)
4. Documentation added explaining GPU flow in glm_position.rs

Run: ls target/debug/build/*/out/*rope*.hsaco && echo "RoPE kernels compiled"
</verification>

<success_criteria>
1. Both RoPE kernels compile successfully (HSACO files present in build output)
2. Build logs explicitly confirm "Compiled kernels/rope.hip" and "Compiled kernels/position_embeddings.hip"
3. Code review confirms no to_host_vec() in GPU RoPE hot path
4. Execution flow documented in glm_position.rs at apply_position_embeddings_device()
</success_criteria>

<output>
After completion, create `.planning/phases/16-gpu-rope-implementation/16-01-SUMMARY.md`
</output>
