---
phase: 19-wavefront-native-quantized-matmul
plan: 03
type: execute
wave: 3
depends_on: ["19-02"]
files_modified: ["kernels/fused_dequant_rmsnorm.hip"]
autonomous: true

must_haves:
  truths:
    - "__shfl_down_f32 in fused_dequant_rmsnorm.hip replaced with HIP __shfl_down"
    - "Fused RMSNorm kernel compiles without CUDA intrinsic errors"
    - "No warp32 assumptions remain (wave64-compatible)"
  artifacts:
    - path: "kernels/fused_dequant_rmsnorm.hip"
      provides: "Fused Q4_0 dequantization + RMSNorm with HIP wave reduction"
      min_lines: 200
      contains: "__shfl_down\\(sum_sq, stride\\)"
      not_contains: "__shfl_down_f32|WARP_SIZE.*32|s_partial\\s*\\[\\s*32\\s*\\]"
  key_links:
    - from: "fused_q4_0_rmsnorm_batch_kernel"
      to: "wave reduction"
      via: "RMS computation uses HIP shuffle for sum-of-squares reduction"
      pattern: "__shfl_down\\(sum_sq, stride\\)"
    - from: "WARP_SIZE constant"
      to: "64"
      via: "RDNA3 wavefront size is 64, not CUDA warp 32"
      pattern: "WARP_SIZE\\s+64"
---

<objective>
Replace CUDA __shfl_down_f32 intrinsic with HIP-native __shfl_down in the fused dequantization + RMSNorm kernel and verify WARP_SIZE is correctly set to 64.

Purpose: Complete the CUDA intrinsic removal from all quantized kernels. The fused_dequant_rmsnorm.hip kernel has one remaining __shfl_down_f32 call (line 225) in the RMS computation reduction loop. This is the last CUDA intrinsic in the quantized kernel set. Also verify WARP_SIZE is correct for RDNA3.

Output: HIP-native fused dequantization + RMSNorm kernel with wave64 alignment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/19-wavefront-native-quantized-matmul/19-RESEARCH.md
@.planning/research/ANTI_CUDA_PORTING_RATIONALE.md
@.planning/phases/19-wavefront-native-quantized-matmul/19-02-SUMMARY.md

@kernels/fused_dequant_rmsnorm.hip
@/home/feanor/Projects/rocm-examples/HIP-Basic/warp_shuffle/main.hip
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and correct WARP_SIZE in fused_dequant_rmsnorm.hip</name>
  <files>kernels/fused_dequant_rmsnorm.hip</files>
  <action>
    In fused_dequant_rmsnorm.hip, check the WARP_SIZE constant definition:

    grep -n "WARP_SIZE" kernels/fused_dequant_rmsnorm.hip

    Expected: WARP_SIZE should be 64 for RDNA3 (not 32 for CUDA).
    If defined as 32: constexpr int WARP_SIZE = 32;
    Change to:     constexpr int WARP_SIZE = 64;

    Rationale: RDNA3 wavefronts have 64 threads. Using 32 causes:
    - Undersized shared memory arrays
    - Incorrect loop bounds in wave reduction
    - Potential race conditions

    If the file has no WARP_SIZE constant, check for hardcoded [32] in shared arrays:
    - s_partial[32] should be s_partial[64] or s_partial[WARP_SIZE]
  </action>
  <verify>
    grep -n "WARP_SIZE.*64\|constexpr.*WARP_SIZE" /home/feanor/Projects/ROCmForge/kernels/fused_dequant_rmsnorm.hip
    # Expected: Shows WARP_SIZE 64 or no hardcoded [32] arrays
  </verify>
  <done>
    fused_dequant_rmsnorm.hip: WARP_SIZE verified as 64 (or no warp32 assumptions)
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace __shfl_down_f32 in fused_dequant_rmsnorm.hip</name>
  <files>kernels/fused_dequant_rmsnorm.hip</files>
  <action>
    In fused_dequant_rmsnorm.hip, locate the fused_q4_0_rmsnorm_batch_kernel function.
    Find the wave reduction loop for sum_sq (around line 224-226).

    Replace line 225:
      sum_sq += __shfl_down_f32(sum_sq, stride, WARP_SIZE);
    With:
      sum_sq += __shfl_down(sum_sq, stride);

    Key change: Remove _f32 suffix (HIP uses type-generic __shfl_down) and remove WARP_SIZE parameter (HIP infers from wavefront).

    Verify the context: This is in the RMS computation where sum_sq (sum of squares) is reduced across the wavefront using shuffle-down operations.

    DO NOT change any other part of the kernel.
    DO NOT import CUDA code or patterns.
  </action>
  <verify>
    grep -n "__shfl_down_f32" /home/feanor/Projects/ROCmForge/kernels/fused_dequant_rmsnorm.hip || echo "PASS: No __shfl_down_f32 found"
    grep -n "__shfl_down(" /home/feanor/Projects/ROCmForge/kernels/fused_dequant_rmsnorm.hip | grep -v "WARP_SIZE" || echo "PASS: __shfl_down calls have no WARP_SIZE parameter"
  </verify>
  <done>
    fused_dequant_rmsnorm.hip: __shfl_down_f32 replaced with __shfl_down (1 occurrence at line 225), WARP_SIZE parameter removed
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify all quantized kernels are CUDA-intrinsic-free</name>
  <files>kernels/q4_0_matmul.hip, kernels/q4_k_matmul.hip, kernels/q6_k_matmul.hip, kernels/fused_dequant_rmsnorm.hip</files>
  <action>
    Run comprehensive grep across all four quantized kernels to confirm NO CUDA intrinsics remain:

    grep -r "__shfl_down_f32" kernels/q4_0_matmul.hip kernels/q4_k_matmul.hip kernels/q6_k_matmul.hip kernels/fused_dequant_rmsnorm.hip

    Expected: No matches (all replaced with __shfl_down)

    Also verify HIP-native patterns are present:
    grep -r "__builtin_amdgcn_wave_reduce_fadd\|__shfl_down(" kernels/q4_0_matmul.hip kernels/q4_k_matmul.hip kernels/q6_k_matmul.hip kernels/fused_dequant_rmsnorm.hip

    Expected: Matches for __builtin_amdgcn_wave_reduce_fadd (primary path) and __shfl_down (fallback path)

    Verify WARP_SIZE is 64 across all kernels:
    grep -r "WARP_SIZE.*32" kernels/q4_0_matmul.hip kernels/q4_k_matmul.hip kernels/q6_k_matmul.hip kernels/fused_dequant_rmsnorm.hip || echo "PASS: No WARP_SIZE 32 found"
  </action>
  <verify>
    grep -r "__shfl_down_f32" /home/feanor/Projects/ROCmForge/kernels/q4_0_matmul.hip /home/feanor/Projects/ROCmForge/kernels/q4_k_matmul.hip /home/feanor/Projects/ROCmForge/kernels/q6_k_matmul.hip /home/feanor/Projects/ROCmForge/kernels/fused_dequant_rmsnorm.hip || echo "PASS: No CUDA intrinsics found"
    grep -r "WARP_SIZE.*32" /home/feanor/Projects/ROCmForge/kernels/q4_0_matmul.hip /home/feanor/Projects/ROCmForge/kernels/q4_k_matmul.hip /home/feanor/Projects/ROCmForge/kernels/q6_k_matmul.hip /home/feanor/Projects/ROCmForge/kernels/fused_dequant_rmsnorm.hip || echo "PASS: No WARP_SIZE 32 found"
  </verify>
  <done>
    All 4 quantized kernels verified: zero __shfl_down_f32 occurrences, zero WARP_SIZE=32, HIP-native patterns present
  </done>
</task>

</tasks>

<verification>
- grep for __shfl_down_f32 across all 4 kernel files returns "PASS: No CUDA intrinsics found"
- grep for WARP_SIZE 32 across all 4 kernel files returns "PASS: No WARP_SIZE 32 found"
- grep for __builtin_amdgcn_wave_reduce_fadd shows primary HIP path exists
- grep for __shfl_down( shows fallback HIP path exists WITHOUT WARP_SIZE parameter
</verification>

<success_criteria>
- Zero __shfl_down_f32 occurrences in q4_0_matmul.hip, q4_k_matmul.hip, q6_k_matmul.hip, fused_dequant_rmsnorm.hip
- Zero WARP_SIZE=32 definitions across all four kernels
- All wave reduction operations use HIP intrinsics (__builtin_amdgcn_wave_reduce_fadd or __shfl_down)
- All __shfl_down calls have 2 parameters (not 3, WARP_SIZE parameter removed)
- Fused RMSNorm kernel ready for compilation testing (19-04)
</success_criteria>

<output>
After completion, create `.planning/phases/19-wavefront-native-quantized-matmul/19-03-SUMMARY.md` with verification results.
</output>
