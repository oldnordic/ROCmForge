---
phase: 19-wavefront-native-quantized-matmul
plan: 04
type: execute
wave: 4
depends_on: ["19-02", "19-03"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All 4 quantized kernels compile for gfx1100 without errors"
    - "No CUDA intrinsic compilation errors"
    - "Numerical correctness validated against CPU reference"
    - "WARP_SIZE verified as 64 across all kernels (RDNA3 wavefront alignment)"
  artifacts:
    - path: "build/q4_0_matmul.hsaco"
      provides: "Compiled Q4_0 matmul kernel for gfx1100"
      min_lines: 1
    - path: "build/q4_k_matmul.hsaco"
      provides: "Compiled Q4_K matmul kernel for gfx1100"
      min_lines: 1
    - path: "build/q6_k_matmul.hsaco"
      provides: "Compiled Q6_K matmul kernel for gfx1100"
      min_lines: 1
    - path: "build/fused_q4_0_rmsnorm.hsaco"
      provides: "Compiled fused dequant+RMSNorm kernel for gfx1100"
      min_lines: 1
  key_links:
    - from: "build.rs"
      to: "kernels/*.hip"
      via: "Cargo build process compiles HIP kernels to HSACO"
      pattern: "Q4_0_MATMUL_HSACO|Q4_K_MATMUL_HSACO|Q6_K_MATMUL_HSACO|FUSED_DEQUANT_RMSNORM_HSACO"
    - from: "WARP_SIZE constant"
      to: "64"
      via: "All kernels use wave64 alignment for RDNA3"
      pattern: "WARP_SIZE\\s+64"
---

<objective>
Compile and validate HIP-native quantized matmul kernels, verifying compilation success, WARP_SIZE correctness, tile size alignment, and numerical correctness.

Purpose: Verify that the CUDA intrinsic removal and WARP_SIZE corrections produce working kernels. Compile all 4 kernels for gfx1100 (RDNA3) and run tests to confirm numerical correctness matches CPU reference implementations. This is the validation phase before marking Phase 19 complete.

Output: Compiled HSACO files and validation tests confirming HIP-native kernels work correctly with wave64 alignment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/19-wavefront-native-quantized-matmul/19-RESEARCH.md
@.planning/research/ANTI_CUDA_PORTING_RATIONALE.md
@.planning/phases/19-wavefront-native-quantized-matmul/19-02-SUMMARY.md
@.planning/phases/19-wavefront-native-quantized-matmul/19-03-SUMMARY.md

@build.rs
@src/ggml/hip_backend/ops/q4_0_dequant.rs
@src/ggml/hip_backend/ops/q4_k_dequant.rs
@src/ggml/hip_backend/ops/q6_k_dequant.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Compile Q4_0 matmul kernel</name>
  <files>kernels/q4_0_matmul.hip, build.rs</files>
  <action>
    Compile q4_0_matmul.hip for gfx1100 using hipcc:

    export ROCM_PATH=/opt/rocm
    export HIPCC=$ROCM_PATH/bin/hipcc
    $HIPCC -c --genco --offload-arch=gfx1100 -O3 \
      kernels/q4_0_matmul.hip -o build/q4_0_matmul.hsaco

    Verify:
    1. Compilation succeeds (exit code 0)
    2. No CUDA intrinsic errors (no "undefined identifier __shfl_down_f32")
    3. HSACO file is produced

    If compilation fails, capture error output. Most likely causes:
    - hipcc not found (install ROCm)
    - Permission issue on build/ directory (mkdir -p build)
  </action>
  <verify>
    ls -la /home/feanor/Projects/ROCmForge/build/q4_0_matmul.hsaco && file /home/feanor/Projects/ROCmForge/build/q4_0_matmul.hsaco
  </verify>
  <done>
    q4_0_matmul.hsaco compiled successfully, file exists and is valid ELF binary
  </done>
</task>

<task type="auto">
  <name>Task 2: Compile Q4_K and Q6_K matmul kernels</name>
  <files>kernels/q4_k_matmul.hip, kernels/q6_k_matmul.hip</files>
  <action>
    Compile both K-quant kernels for gfx1100:

    $HIPCC -c --genco --offload-arch=gfx1100 -O3 \
      kernels/q4_k_matmul.hip -o build/q4_k_matmul.hsaco

    $HIPCC -c --genco --offload-arch=gfx1100 -O3 \
      kernels/q6_k_matmul.hip -o build/q6_k_matmul.hsaco

    Verify both compile without CUDA intrinsic errors.
    Both kernels have the same wave_reduce_sum pattern as q4_0_matmul.hip (fixed in 19-02).
  </action>
  <verify>
    ls -la /home/feanor/Projects/ROCmForge/build/q4_k_matmul.hsaco /home/feanor/Projects/ROCmForge/build/q6_k_matmul.hsaco
  </verify>
  <done>
    q4_k_matmul.hsaco and q6_k_matmul.hsaco compiled successfully
  </done>
</task>

<task type="auto">
  <name>Task 3: Compile fused dequant+RMSNorm kernel</name>
  <files>kernels/fused_dequant_rmsnorm.hip</files>
  <action>
    Compile the fused dequantization + RMSNorm kernel:

    $HIPCC -c --genco --offload-arch=gfx1100 -O3 \
      kernels/fused_dequant_rmsnorm.hip -o build/fused_q4_0_rmsnorm.hsaco

    Verify compilation succeeds. This kernel had the __shfl_down_f32 at line 225 (fixed in 19-03).
  </action>
  <verify>
    ls -la /home/feanor/Projects/ROCmForge/build/fused_q4_0_rmsnorm.hsaco
  </verify>
  <done>
    fused_q4_0_rmsnorm.hsaco compiled successfully
  </done>
</task>

<task type="auto">
  <name>Task 4: Run CPU reference tests for numerical validation</name>
  <files>src/ggml/hip_backend/ops/q4_0_dequant.rs, src/ggml/hip_backend/ops/q4_k_dequant.rs, src/ggml/hip_backend/ops/q6_k_dequant.rs</files>
  <action>
    Run the CPU reference dequantization tests to establish numerical baseline:

    cargo test dequantize_q4_0_cpu --lib
    cargo test dequantize_q4_k_cpu --lib
    cargo test dequantize_q6_k_cpu --lib

    These tests verify the CPU implementations are numerically correct against the format specifications.
    The GPU kernels should produce identical results (within floating-point tolerance).

    All tests should pass. These are the reference implementations that validate:
    - Q4_0: unpack 4-bit values, apply scale, convert to signed range (-8 to +7)
    - Q4_K: unpack 4-bit values, apply scale + min
    - Q6_K: unpack 6-bit values, apply signed conversion, multiply by scale
  </action>
  <verify>
    cargo test dequantize_q4_0_cpu dequantize_q4_k_cpu dequantize_q6_k_cpu --lib 2>&1 | grep -E "test result|running"
  </verify>
  <done>
    All CPU dequantization tests pass (3 test suites, 9+ tests total)
  </done>
</task>

<task type="auto">
  <name>Task 5: Verify WARP_SIZE and tile alignment across all kernels</name>
  <files>kernels/q4_0_matmul.hip, kernels/q4_k_matmul.hip, kernels/q6_k_matmul.hip, kernels/fused_dequant_rmsnorm.hip</files>
  <action>
    Final verification: grep entire kernels/ directory for WARP_SIZE and tile size alignment:

    # WARP_SIZE should be 64 (RDNA3), not 32 (CUDA):
    grep -r "WARP_SIZE.*32" \
      kernels/q4_0_matmul.hip kernels/q4_k_matmul.hip \
      kernels/q6_k_matmul.hip kernels/fused_dequant_rmsnorm.hip || echo "PASS: No WARP_SIZE 32 found"

    grep -r "WARP_SIZE.*64" \
      kernels/q4_0_matmul.hip kernels/q4_k_matmul.hip \
      kernels/q6_k_matmul.hip kernels/fused_dequant_rmsnorm.hip

    # Tile sizes should be wave64-aligned (divisible by 64):
    grep -r "TILE_SIZE_[KN].*[0-9]" \
      kernels/q4_0_matmul.hip kernels/q4_k_matmul.hip \
      kernels/q6_k_matmul.hip

    Document in 19-04-SUMMARY.md:
    - Current TILE_SIZE_K and TILE_SIZE_N values
    - Whether they are wave64-aligned (divisible by 64)
    - Any known issues with tile size alignment
  </action>
  <verify>
    grep -r "WARP_SIZE.*32" /home/feanor/Projects/ROCmForge/kernels/*.hip 2>/dev/null | wc -l
    # Expected output: 0
  </verify>
  <done>
    WARP_SIZE verified as 64 across all kernels, tile size alignment documented in 19-04-SUMMARY.md
  </done>
</task>

<task type="auto">
  <name>Task 6: Verify no CUDA intrinsics remain across all kernels</name>
  <files>kernels/q4_0_matmul.hip, kernels/q4_k_matmul.hip, kernels/q6_k_matmul.hip, kernels/fused_dequant_rmsnorm.hip</files>
  <action>
    Final verification: grep entire kernels/ directory for any remaining CUDA intrinsics:

    # CUDA-specific intrinsics that should NOT exist:
    grep -r "__shfl_down_f32\|__shfl_sync\|__activemask" \
      kernels/q4_0_matmul.hip kernels/q4_k_matmul.hip \
      kernels/q6_k_matmul.hip kernels/fused_dequant_rmsnorm.hip || echo "PASS: No CUDA intrinsics"

    # HIP-native patterns that SHOULD exist:
    grep -r "__builtin_amdgcn_wave_reduce_fadd\|__shfl_down(" \
      kernels/q4_0_matmul.hip kernels/q4_k_matmul.hip \
      kernels/q6_k_matmul.hip kernels/fused_dequant_rmsnorm.hip

    # Verify __shfl_down calls do NOT have WARP_SIZE parameter:
    grep -r "__shfl_down(.*,.*,WARP_SIZE)" \
      kernels/q4_0_matmul.hip kernels/q4_k_matmul.hip \
      kernels/q6_k_matmul.hip kernels/fused_dequant_rmsnorm.hip || echo "PASS: No 3-parameter __shfl_down calls"

    Expected: First grep returns "PASS: No CUDA intrinsics", second grep shows HIP patterns, third grep returns "PASS: No 3-parameter __shfl_down calls"
  </action>
  <verify>
    grep -r "__shfl_down_f32" /home/feanor/Projects/ROCmForge/kernels/*.hip 2>/dev/null | wc -l
    # Expected output: 0
    grep -r "__shfl_down(.*,.*,WARP_SIZE)" /home/feanor/Projects/ROCmForge/kernels/*.hip 2>/dev/null | wc -l
    # Expected output: 0
  </verify>
  <done>
    Final verification: 0 CUDA intrinsics, 0 WARP_SIZE parameters in __shfl_down, HIP-native patterns confirmed
  </done>
</task>

</tasks>

<verification>
- All 4 HSACO files compiled and exist in build/
- CPU reference tests pass (dequantize_q4_0_cpu, dequantize_q4_k_cpu, dequantize_q6_k_cpu)
- grep for __shfl_down_f32 returns 0 matches across all kernels
- grep for __shfl_down(.*,.*,WARP_SIZE) returns 0 matches (no WARP_SIZE parameter in __shfl_down calls)
- grep for WARP_SIZE.*32 returns 0 matches (all use wave64)
- grep for __builtin_amdgcn_wave_reduce_fadd and __shfl_down( shows HIP patterns
- Tile size alignment status documented in 19-04-SUMMARY.md
</verification>

<success_criteria>
- q4_0_matmul.hsaco, q4_k_matmul.hsaco, q6_k_matmul.hsaco, fused_q4_0_rmsnorm.hsaco all compiled
- Zero CUDA intrinsic compilation errors
- Zero __shfl_down_f32 occurrences in any kernel
- Zero __shfl_down calls with WARP_SIZE parameter (all 2-parameter calls)
- WARP_SIZE verified as 64 across all kernels (no WARP_SIZE 32)
- CPU reference tests pass (numerical baseline established)
- Tile size alignment documented (known issues if any)
</success_criteria>

<output>
After completion, create `.planning/phases/19-wavefront-native-quantized-matmul/19-04-SUMMARY.md` with compilation results, WARP_SIZE verification, tile size alignment status, and verification summary.
</output>
