---
phase: 13-03-dead-code-removal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/tensor/matmul.rs
  - src/http/server.rs
  - src/model/execution_plan/layer_plan.rs
  - src/model/execution_plan/execution_plan_src.rs
  - src/loader/tensor_type.rs
autonomous: true

must_haves:
  truths:
    - "All #[allow(dead_code)] markers are reviewed and acted on (except FFI and TODO futures)"
    - "Q[2-6]_K enum variants have #[allow(non_camel_case_types)] to suppress naming warnings"
    - "Truly unused functions (transpose_in_place_gpu, deprecated constructors) are removed"
    - "Test-only code has #[allow(dead_code)] marker removed (tests are part of the crate)"
    - "cargo check shows reduced dead_code warnings"
  artifacts:
    - path: "src/tensor/matmul.rs"
      contains: "transpose_in_place_gpu"
      min_lines: 0
      action: "function removed entirely"
    - path: "src/http/server.rs"
      not_contains: "#[allow(dead_code)]"
      min_lines: 0
      action: "marker removed from impl InferenceServer"
    - path: "src/model/execution_plan/layer_plan.rs"
      contains: "pub fn new"
      min_lines: 0
      action: "LayerPlan::new removed or marker corrected"
    - path: "src/model/execution_plan/execution_plan_src.rs"
      not_contains: "#[allow(dead_code)]"
      min_lines: 0
      action: "markers removed from active methods, deprecated functions removed"
    - path: "src/loader/tensor_type.rs"
      contains: "#[allow(non_camel_case_types)]"
      min_lines: 1
      action: "enum has allowance for GGUF format compliance"
  key_links:
    - from: "src/loader/tensor_type.rs"
      to: "GGUF specification"
      via: "Q2_K, Q3_K, etc. match external format"
      pattern: "Q[2-6]_K.*GGML_TYPE"
---

<objective>
Resolve `#[allow(dead_code)]` markers and suppress naming convention warnings for GGUF compatibility.

Purpose: Clean up dead code suppressions, remove truly unused code, and properly document exceptions for external format compatibility. This reduces a significant category of compiler warnings while preserving code that is either actively used or matches external specifications.

Output: 5 fewer `#[allow(dead_code)]` markers, truly unused functions removed, GGUF naming warnings properly suppressed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/13-03-dead-code-removal/13-03-CONTEXT.md
@.planning/phases/13-03-dead-code-removal/13-03-RESEARCH.md

# Source files to modify
@src/tensor/matmul.rs
@src/http/server.rs
@src/model/execution_plan/layer_plan.rs
@src/model/execution_plan/execution_plan_src.rs
@src/loader/tensor_type.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove truly unused transpose_in_place_gpu function</name>
  <files>src/tensor/matmul.rs</files>
  <action>
    From src/tensor/matmul.rs, remove the entire `transpose_in_place_gpu` function (lines 197-223).

    This function is marked `#[allow(dead_code)]` and a search (`rg "transpose_in_place_gpu" --type rust`) confirms it has zero usages in the codebase.

    DO NOT remove:
    - cpu_matmul_f32 function (used in tests)
    - The #[cfg(test)] mod tests block

    Commit message: "refactor(13-03-01): remove unused transpose_in_place_gpu function"
  </action>
  <verify>cargo check --all-targets 2>&1 | grep -c "warning:" (should decrease)</verify>
  <done>transpose_in_place_gpu function removed from src/tensor/matmul.rs</done>
</task>

<task type="auto">
  <name>Task 2: Remove incorrect dead_code marker from InferenceServer impl</name>
  <files>src/http/server.rs</files>
  <action>
    From src/http/server.rs line 227, remove the `#[allow(dead_code)]` marker from the `impl InferenceServer` block.

    This marker is INCORRECT - the methods in this impl (new, engine, require_engine, tokenize_prompt, etc.) ARE used in tests. Tests are part of the crate, so test-only usage is still valid usage.

    Remove only the marker line. Do NOT modify the impl or its methods.

    Commit message: "refactor(13-03-01): remove incorrect dead_code marker from InferenceServer impl"
  </action>
  <verify>cargo check --all-targets 2>&1 | grep -c "warning:" (should decrease or stay same)</verify>
  <done>#[allow(dead_code)] removed from InferenceServer impl</done>
</task>

<task type="auto">
  <name>Task 3: Remove deprecated LayerPlan::new and its marker</name>
  <files>src/model/execution_plan/layer_plan.rs</files>
  <action>
    From src/model/execution_plan/layer_plan.rs, remove both the `#[allow(dead_code)]` marker (line 62) AND the entire deprecated `LayerPlan::new()` method (lines 63-74).

    This method:
1. Is marked deprecated
2. Always panics when called
3. Has been replaced by ExecutionPlan::from_gguf()

    Research confirmed zero usages of this method.

    Commit message: "refactor(13-03-01): remove deprecated LayerPlan::new constructor"
  </action>
  <verify>cargo check --all-targets 2>&1 | grep -c "warning:" (should decrease)</verify>
  <done>LayerPlan::new method and its dead_code marker removed</done>
</task>

<task type="auto">
  <name>Task 4: Fix ExecutionPlan dead_code markers and remove deprecated function</name>
  <files>src/model/execution_plan/execution_plan_src.rs</files>
  <action>
    From src/model/execution_plan/execution_plan_src.rs, make TWO changes:

    1. Remove the `#[allow(dead_code)]` marker from line 83. The impl block contains methods like `layers()` and `config()` that ARE actively used - the marker was wrong.

    2. Remove the deprecated `_legacy_try_gpu_attention` function entirely (lines 2569-2584). This function:
       - Is marked with #[allow(dead_code)]
       - Only returns an error telling callers to use the newer method
       - Has been superseded by scaled_dot_product_attention for GQA support

    DO NOT remove:
    - The actual ExecutionPlan impl methods (layers, config, etc.)
    - Any other functions in the file

    Commit message: "refactor(13-03-01): fix ExecutionPlan dead_code markers and remove _legacy_try_gpu_attention"
  </action>
  <verify>cargo check --all-targets 2>&1 | grep -c "warning:" (should decrease)</verify>
  <done>ExecutionPlan dead_code markers resolved, legacy function removed</done>
</task>

<task type="auto">
  <name>Task 5: Add #[allow(non_camel_case_types)] to GgufTensorType enum</name>
  <files>src/loader/tensor_type.rs</files>
  <action>
    Add `#[allow(non_camel_case_types)]` attribute to the GgufTensorType enum in src/loader/tensor_type.rs.

    The Q2_K, Q3_K, Q4_K, Q5_K, Q6_K variants match the external GGUF/ggml specification format. These naming conventions are required for compatibility and should NOT be changed to UpperCamelCase.

    Add the allow attribute on line 9, just before the enum definition:

    ```rust
    /// GGUF tensor types (ggml_type enum values from ggml.h)
    #[derive(Debug, Clone, PartialEq, Copy, Serialize)]
    #[repr(u8)]
    #[allow(non_camel_case_types)]  // Q*_K variants match GGUF specification
    pub enum GgufTensorType {
    ```

    Commit message: "refactor(13-03-01): suppress non_camel_case_types warning for GGUF compatibility"
  </action>
  <verify>cargo check --all-targets 2>&1 | grep "Q[2-6]_K.*should have an upper camel case name" | wc -l (should be 0)</verify>
  <done>GgufTensorType enum has allow attribute for GGUF naming</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. cargo check --all-targets runs without errors
2. grep -rn '#\[allow(dead_code)\]' src/ shows only 3 markers (backend.rs:11 FFI block, backend_registry.rs:302,367 TODO fields)
3. Q[2-6]_K naming warnings are suppressed
4. Full test suite still passes: cargo test --all-targets
</verification>

<success_criteria>
- 5 fewer #[allow(dead_code)] markers (from 8 to 3)
- Q[2-6]_K naming warnings suppressed
- Truly unused functions removed
- No compilation errors
- All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/13-03-dead-code-removal/13-03-01-SUMMARY.md`
</output>
