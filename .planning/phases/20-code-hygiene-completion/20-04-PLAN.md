---
phase: 20-code-hygiene-completion
plan: 04
type: execute
wave: 2
depends_on: ["20-01", "20-02", "20-03"]
files_modified:
  - src/attention/flash_attention.rs
  - src/attention/gpu.rs
  - src/attention/mod.rs
  - src/profiling/ttft.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All deprecated method warnings are eliminated"
    - "HipBuffer::copy_to_host replaced with HipBackend::copy_from_device_safe"
    - "DeviceTensor::to_host_vec replaced with HipBackend::copy_from_device_safe"
  artifacts:
    - path: "src/attention/flash_attention.rs"
      provides: "Replaced deprecated HipBuffer::copy_to_host calls"
      contains: "backend.copy_from_device_safe or similar"
    - path: "src/attention/gpu.rs"
      provides: "Replaced all deprecated method calls"
      contains: "copy_from_device_safe pattern"
    - path: "src/attention/mod.rs"
      provides: "Replaced deprecated to_host_vec call"
      contains: "copy_from_device_safe pattern"
  key_links:
    - from: "deprecated calls"
      to: "HipBackend::copy_from_device_safe"
      via: "direct replacement pattern"
      pattern: "\.copy_to_host\(|\.to_host_vec\("
---

<objective>
Replace all deprecated method calls with their recommended replacements.

Purpose: The deprecated methods HipBuffer::copy_to_host and DeviceTensor::to_host_vec should be replaced with HipBackend::copy_from_device_safe for clearer intent and better error handling.

Output: 18 deprecated method warnings eliminated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@src/backend/hip_backend/backend.rs
</context>

<tasks>

<task type="auto">
  <name>Read HipBackend::copy_from_device_safe documentation</name>
  <files>src/backend/hip_backend/backend.rs</files>
  <action>
    Read src/backend/hip_backend/backend.rs to find the HipBackend::copy_from_device_safe method.
    Understand its signature and usage pattern.
    This is necessary to correctly replace the deprecated methods.

    Look for:
    - fn copy_from_device_safe signature
    - Parameters required (buffer, size, etc.)
    - Return type (Result<Vec<T>, Error>)
    - Usage examples in the codebase
  </action>
  <verify>Found copy_from_device_safe method signature and documentation</verify>
  <done>Understand the replacement API pattern</done>
</task>

<task type="auto">
  <name>Replace deprecated HipBuffer::copy_to_host calls</name>
  <files>
    src/attention/flash_attention.rs
    src/attention/gpu.rs
  </files>
  <action>
    Replace HipBuffer::copy_to_host calls with HipBackend::copy_from_device_safe.

    Locations (9 calls):
    - src/attention/flash_attention.rs:222
    - src/attention/flash_attention.rs:292
    - src/attention/gpu.rs:140
    - src/attention/gpu.rs:224
    - src/attention/gpu.rs:267
    - src/attention/gpu.rs:347
    - src/attention/gpu.rs:358
    - (and 1 more in gpu.rs)

    Pattern to find: buffer.copy_to_host()
    Replacement pattern: backend.copy_from_device_safe(&buffer, buffer.size())?

    Note: Read the surrounding code context for each call to ensure proper error handling.
  </action>
  <verify>grep -n "deprecated.*copy_to_host" &lt;(cargo check --features rocm 2>&1) returns no results</verify>
  <done>All HipBuffer::copy_to_host calls replaced</done>
</task>

<task type="auto">
  <name>Replace deprecated DeviceTensor::to_host_vec calls</name>
  <files>
    src/attention/gpu.rs
    src/attention/mod.rs
  </files>
  <action>
    Replace DeviceTensor::to_host_vec calls with HipBackend::copy_from_device_safe.

    Locations (10 calls):
    - src/attention/gpu.rs:379, 382, 385, 389 (and more)
    - src/attention/mod.rs:166

    Pattern to find: tensor.to_host_vec()
    Replacement pattern: backend.copy_from_device_safe(tensor.data(), tensor.element_count())?

    Note: DeviceTensor likely has methods like data() and element_count() or size().
    Read the DeviceTensor implementation to confirm accessor method names.
  </action>
  <verify>grep -n "deprecated.*to_host_vec" &lt;(cargo check --features rocm 2>&1) returns no results</verify>
  <done>All DeviceTensor::to_host_vec calls replaced</done>
</task>

<task type="auto">
  <name>Verify all deprecated method warnings fixed</name>
  <files></files>
  <action>
    Run cargo check --features rocm.
    Verify no "deprecated" warnings remain for copy_to_host or to_host_vec.
    Count remaining warnings (should be 44, down from 62).
  </action>
  <verify>grep -c "deprecated" &lt;(cargo check --features rocm 2>&1) outputs 0 for method warnings</verify>
  <done>All 18 deprecated method calls replaced</done>
</task>

</tasks>

<verification>
1. Read src/backend/hip_backend/backend.rs and confirm copy_from_device_safe signature
2. Run cargo check --features rocm and verify no deprecated method warnings
3. Verify all attention tests still pass (the GPU operations still work)
</verification>

<success_criteria>
- Zero deprecated method warnings (was 18, now 0)
- Total warning count reduced from 62 to 44
- All GPU copy operations use the new API
- Attention functionality still works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/20-code-hygiene-completion/20-04-SUMMARY.md`
</output>
