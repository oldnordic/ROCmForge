---
phase: 20-code-hygiene-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ggml/hip_backend/mod.rs
  - src/loader/metadata.rs
  - src/backend/hip_backend/backend.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All unreachable pattern warnings are eliminated"
    - "No unexpected_cfg warnings remain (feature name fixes applied)"
    - "cargo check --features rocm passes without unreachable/unexpected_cfg warnings"
  artifacts:
    - path: "src/ggml/hip_backend/mod.rs"
      provides: "Fixed unreachable pattern in match statement"
      contains: "no unreachable _ pattern at line 1286"
    - path: "src/loader/metadata.rs"
      provides: "Fixed duplicate rms_norm_eps pattern"
      contains: "no duplicate yi.rms_norm_eps pattern"
    - path: "src/backend/hip_backend/backend.rs"
      provides: "Fixed feature name from 'std' to valid feature"
      contains: "#[cfg(feature = \"rocm\")] or no cfg gate"
  key_links:
    - from: "src/ggml/hip_backend/mod.rs"
      to: "match op expression"
      via: "exhaustive pattern matching without unreachable _"
      pattern: "match.*op.*\\{.*\\}"
    - from: "src/backend/hip_backend/backend.rs"
      to: "Cargo.toml features"
      via: "valid feature name in cfg attribute"
      pattern: "#\\[cfg\\(feature = \"rocm\"\\)\\]"
---

<objective>
Fix unreachable pattern and unexpected_cfg warnings to establish baseline hygiene.

Purpose: Unreachable patterns indicate dead code that should be removed. Invalid feature cfg values (std) indicate a copy-paste error from std-aware code. Both are trivial fixes that establish a clean baseline.

Output: Two unreachable patterns removed, two cfg feature values corrected.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Fix unreachable pattern in hip_backend/mod.rs</name>
  <files>src/ggml/hip_backend/mod.rs</files>
  <action>
    Read src/ggml/hip_backend/mod.rs around line 1286 to see the full match expression.
    The unreachable _ pattern indicates all Op variants are already explicitly handled.
    Remove the catch-all _ => Err(...) pattern since it's unreachable.
    Verify the match remains exhaustive (all Op variants have explicit arms).
  </action>
  <verify>grep -n "unreachable pattern" &lt;(cargo check --features rocm 2>&1) returns no results for mod.rs:1286</verify>
  <done>Match expression is exhaustive without unreachable _ pattern</done>
</task>

<task type="auto">
  <name>Fix duplicate yi.rms_norm_eps pattern in metadata.rs</name>
  <files>src/loader/metadata.rs</files>
  <action>
    Read src/loader/metadata.rs lines 150-190.
    Line 151 already handles "yi.rms_norm_eps" (aliased from "yi.attention.layer_norm_rms_epsilon").
    Line 186 has a duplicate "yi.rms_norm_eps" pattern that is unreachable.
    Remove the duplicate pattern at line 186 (| "yi.rms_norm_eps" =>).
    The pattern at line 151 already maps this key correctly.
  </action>
  <verify>grep -n "unreachable pattern" &lt;(cargo check --features rocm 2>&1) returns no results for metadata.rs:186</verify>
  <done>Single yi.rms_norm_eps pattern remains (at line 151)</done>
</task>

<task type="auto">
  <name>Fix unexpected_cfg std feature in backend.rs</name>
  <files>src/backend/hip_backend/backend.rs</files>
  <action>
    Read src/backend/hip_backend/backend.rs lines 516 and 520.
    Both lines use #[cfg(feature = "std")] but "std" is not a valid Cargo feature.
    Available features are: avx512, context, default, rocm, simd, sqlitegraph.
    The backtrace code should use the "rocm" feature gate instead since it's HIP backend specific.
    Replace #[cfg(feature = "std")] with #[cfg(feature = "rocm")] on both lines.
  </action>
  <verify>grep -n "unexpected.*cfg.*std" &lt;(cargo check --features rocm 2>&1) returns no results</verify>
  <done>Backtrace code properly gated by rocm feature</done>
</task>

<task type="auto">
  <name>Verify all unreachable pattern and cfg warnings fixed</name>
  <files></files>
  <action>
    Run cargo check --features rocm.
    Verify no unreachable pattern warnings remain.
    Verify no unexpected_cfg warnings remain.
    Count remaining warnings to confirm reduction (should be 74 remaining, down from 76).
  </action>
  <verify>cargo check --features rocm 2>&1 | grep -c "warning:" outputs 74 (or less)</verify>
  <done>HYGIENE-02 and HYGIENE-06 requirements satisfied</done>
</task>

</tasks>

<verification>
1. Read src/ggml/hip_backend/mod.rs and confirm no unreachable _ pattern at line 1286
2. Read src/loader/metadata.rs and confirm no duplicate yi.rms_norm_eps pattern at line 186
3. Read src/backend/hip_backend/backend.rs and confirm #[cfg(feature = "rocm")] used instead of std
4. Run cargo check --features rocm and verify no unreachable pattern or unexpected_cfg warnings
</verification>

<success_criteria>
- Zero unreachable pattern warnings (was 2, now 0)
- Zero unexpected_cfg warnings (was 2, now 0)
- Total warning count reduced from 76 to 74
- All match expressions remain exhaustive
- Backtrace code properly feature-gated
</success_criteria>

<output>
After completion, create `.planning/phases/20-code-hygiene-completion/20-01-SUMMARY.md`
</output>
