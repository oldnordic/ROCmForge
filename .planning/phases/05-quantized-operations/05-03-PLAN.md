---
phase: 05-quantized-operations
plan: 03
type: execute
depends_on: ["05-02"]
files_modified: [kernels/q8_0_dequant.hip, kernels/q4_k_dequant.hip, build.rs, src/ggml/hip_backend/ops/mod.rs]
autonomous: true
---

<objective>
Implement HIP dequantization kernels for remaining Q-formats (Q8_0, Q4_K, Q6_K).

Purpose: Complete GPU-based dequantization support for all major GGUF quantization formats. Enables efficient inference without CPU dequantization bottleneck.
Output: Working HIP kernels for Q8_0, Q4_K, Q6_K with Rust wrappers, integrated into build system.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/05-quantized-operations/05-01-SUMMARY.md
@.planning/phases/05-quantized-operations/05-02-SUMMARY.md
@src/loader/dequant.rs
@kernels/mxfp_dequant.hip
@kernels/q4_0_dequant.hip
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Q8_0 dequantization HIP kernel</name>
  <files>kernels/q8_0_dequant.hip</files>
  <action>
    Create kernels/q8_0_dequant.hip for Q8_0 format:

    Q8_0 format specification:
    - Block size: 32 elements
    - Per block: scale (f32, 4 bytes) + 32 bytes int8 values = 36 bytes
    - Dequantization: value = scale * int8_value

    Follow same structure as q4_0_dequant.hip:
    - Grid/block sizing for RDNA3 (BLOCK_SIZE=256, WARP_SIZE=32)
    - One kernel: q8_0_to_fp32_batch_kernel
    - Each thread processes one element
    - Direct int8 to float conversion with scale multiplication
  </action>
  <verify>q8_0_dequant.hip created with valid HIP kernel</verify>
  <done>Q8_0 HIP kernel source created</done>
</task>

<task type="auto">
  <name>Task 2: Create Q4_K dequantization HIP kernel</name>
  <files>kernels/q4_k_dequant.hip</files>
  <action>
    Create kernels/q4_k_dequant.hip for Q4_K format:

    Q4_K format specification (from src/loader/dequant.rs):
    - Super-block size: 256 elements (8 sub-blocks of 32 elements each)
    - Per super-block: 16 bytes scales + 16 bytes mins + 160 bytes quants + 64 bytes additional
    - Each sub-block (32 elements): half-precision scale (2 bytes) + int8 min (1 byte) + 20 bytes packed

    Kernel design:
    - Grid: (num_super_blocks, 1, 1)
    - Block: 256 threads (one per element in super-block)
    - Each thread calculates its sub-block and element position
    - Reads scale as f16, converts to f32
    - Unpacks 4-bit values from packed data
    - Applies: value = min + (quant * scale)

    Note: Q4_K is complex due to super-block structure. May need shared memory for scales/mins.
  </action>
  <verify>q4_k_dequant.hip created with valid HIP kernel</verify>
  <done>Q4_K HIP kernel source created</done>
</task>

<task type="auto">
  <name>Task 3: Create Q6_K dequantization HIP kernel</name>
  <files>kernels/q6_k_dequant.hip</files>
  <action>
    Create kernels/q6_k_dequant.hip for Q6_K format:

    Q6_K format specification:
    - Block size: 256 elements
    - Per block: scales (16 half-precision, 32 bytes) + 6-bit packed quants (192 bytes)
    - 16 elements share one scale

    Kernel design:
    - Grid: (num_blocks, 1, 1)
    - Block: 256 threads (one per element)
    - Calculate scale index: i / 16
    - Read half-precision scale, convert to f32
    - Extract 6-bit value (similar to MXFP6 unpacking)
    - Convert to signed range: if >= 32, subtract 64
    - Apply: result = signed_val * scale
  </action>
  <verify>q6_k_dequant.hip created with valid HIP kernel</verify>
  <done>Q6_K HIP kernel source created</done>
</task>

<task type="auto">
  <name>Task 4: Add kernels to build system</name>
  <files>build.rs</files>
  <action>
    Add Q8_0, Q4_K, Q6_K kernels to build.rs kernels array:

    Add entries after q4_0_dequant:
    ```rust
    (
        "kernels/q8_0_dequant.hip",
        "Q8_0_DEQUANT_HSACO",
        "q8_0_to_fp32_kernel",
    ),
    (
        "kernels/q4_k_dequant.hip",
        "Q4_K_DEQUANT_HSACO",
        "q4_k_to_fp32_kernel",
    ),
    (
        "kernels/q6_k_dequant.hip",
        "Q6_K_DEQUANT_HSACO",
        "q6_k_to_fp32_kernel",
    ),
    ```
  </action>
  <verify>build.rs updated with all new kernels</verify>
  <done>All kernels added to build system</done>
</task>

</tasks>

<verification>
- [ ] kernels/q8_0_dequant.hip created
- [ ] kernels/q4_k_dequant.hip created
- [ ] kernels/q6_k_dequant.hip created
- [ ] build.rs updated with all three kernels
- [ ] cargo check passes
</verification>

<success_criteria>
- All three HIP kernels compile successfully
- Kernel signatures follow established patterns
- Build system integration complete
- Ready for Rust wrapper implementation (separate task if needed)
</success_criteria>

<output>
After completion, create `.planning/phases/05-quantized-operations/05-03-SUMMARY.md`
</output>
